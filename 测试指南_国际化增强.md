# 国际化支持增强功能测试指南

## 功能概述

本次实施完成了以下国际化增强：

1. ✅ **语言切换优化** - 使用 localStorage 缓存，减少 API 调用
2. ✅ **中文日期时间格式化** - 改进 moment.js 配置，支持中文格式
3. ✅ **CJK 排版优化** - 改善中文/日文/韩文的字体和排版
4. ✅ **语言服务** - 统一的语言管理服务

## 新增的功能

### 1. 语言切换服务 (tgLocaleService)

新增了统一的语言管理服务，提供以下功能：

- **本地缓存**: 语言偏好保存在 localStorage，刷新页面时自动恢复
- **即时切换**: 无需重新加载页面即可切换语言
- **RTL 支持**: 自动检测和应用从右到左的文本方向（阿拉伯语、波斯语、希伯来语）
- **Moment.js 集成**: 自动配置日期时间格式化库
- **29 种语言**: 支持包括简体中文、繁体中文、日语、韩语等 29 种语言

### 2. 中文日期时间格式优化

专门为简体中文优化了日期时间显示：

- **中文格式**: "2024年11月4日 16:30" 而不是 "Nov 4 2024 16:30"
- **相对时间**: "3分钟前"、"2小时前"、"昨天"、"明天"
- **星期显示**: "星期一" 到 "星期日"
- **时段标识**: 凌晨、早上、上午、中午、下午、晚上

### 3. CJK 排版优化

专门针对中文、日文、韩文优化了字体和排版：

- **优化字体栈**: 使用 PingFang SC、Hiragino Sans GB、Microsoft YaHei 等现代中文字体
- **行高调整**: 从 1.5 增加到 1.7，提高可读性
- **字距调整**: 适当的 letter-spacing 使文字更舒适
- **引号样式**: 中文使用 ""'' 引号，而不是 ""''
- **文字渲染**: 优化 antialiasing 和 text-rendering
- **混合内容**: 处理 CJK 和拉丁字符混排的间距

---

## 测试前准备

### 1. 确认代码已编译

```bash
cd /workspaces/taiga-front

# 检查 locale 服务是否编译
grep -c "LocaleService" dist/v-*/js/app.js
# 应该输出 > 0

# 检查 CSS 是否编译
ls -lh dist/v-*/styles/theme-taiga.css
# 应该看到文件存在且有一定大小
```

### 2. 启动开发服务器

```bash
npm start
```

浏览器会自动打开 `http://localhost:9001`

---

## 测试步骤

### 测试 1: 语言切换性能优化

**目标**: 验证语言偏好是否被缓存，减少了 API 调用。

**操作**:
1. 打开浏览器开发者工具（F12）
2. 切换到 Network 标签
3. 访问 Taiga 首页 `http://localhost:9001`
4. 登录（如果未登录）
5. 进入用户设置 → Profile
6. 在 Language 下拉菜单中选择 "简体中文 (Chinese Simplified)"
7. 保存设置
8. **刷新页面**（Ctrl+R）

**预期结果**:
- ✅ 页面立即显示中文界面，无需等待
- ✅ Network 标签中没有额外的 locale 相关 API 请求
- ✅ 控制台执行以下命令应该看到缓存的语言：
  ```javascript
  localStorage.getItem('taiga.locale')
  // 应该输出: "zh-hans"
  ```

**如果成功** ✅ 语言切换缓存正常工作！

---

### 测试 2: 中文日期时间格式化

**目标**: 验证中文环境下日期时间的显示格式。

**前提**: 已切换到简体中文语言。

**操作**:
1. 在浏览器控制台执行以下代码：

```javascript
// 测试当前时间
moment().format('LLLL')
// 应该输出类似: "2024年11月4日 星期一 16:30"

moment().format('L')
// 应该输出: "2024年11月04日"

// 测试相对时间
moment().subtract(3, 'minutes').fromNow()
// 应该输出: "3 分钟前"

moment().subtract(2, 'hours').fromNow()
// 应该输出: "2 小时前"

moment().subtract(1, 'day').fromNow()
// 应该输出: "1 天前"

// 测试日历时间
moment().subtract(1, 'day').calendar()
// 应该输出: "昨天 16:30"

moment().add(1, 'day').calendar()
// 应该输出: "明天 16:30"

// 测试时段
moment().hour(8).format('A')
// 应该输出: "早上" 或 "上午"

moment().hour(15).format('A')
// 应该输出: "下午"

moment().hour(20).format('A')
// 应该输出: "晚上"
```

2. 在 Taiga 界面中查看实际的日期显示：
   - Issues 列表中的创建时间
   - User Stories 的最后更新时间
   - Wiki 页面的编辑时间

**预期结果**:
- ✅ 所有日期显示为中文格式（"2024年11月4日"）
- ✅ 相对时间使用中文（"3分钟前"、"2小时前"）
- ✅ 星期显示为"星期一"到"星期日"
- ✅ 时段正确显示（凌晨、早上、上午、中午、下午、晚上）

**如果成功** ✅ 中文日期格式化正常！

---

### 测试 3: CJK 字体显示

**目标**: 验证中文字体是否正确加载和应用。

**操作**:
1. 在浏览器中切换到简体中文
2. 打开开发者工具（F12） → Elements 标签
3. 选中页面上的任意中文文字
4. 在 Styles 面板中查看 `font-family` 属性

**预期结果**:
```css
font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
             "PingFang SC", "Hiragino Sans GB", "Source Han Sans SC",
             "Noto Sans CJK SC", "Microsoft YaHei", "微软雅黑",
             "Helvetica Neue", Helvetica, Arial, sans-serif;
```

在 macOS 上应该使用 **PingFang SC**，在 Windows 上应该使用 **Microsoft YaHei**。

**进一步验证**:
```javascript
// 在控制台执行
getComputedStyle(document.body).fontFamily
// macOS: 应包含 "PingFang SC"
// Windows: 应包含 "Microsoft YaHei"
```

**如果成功** ✅ CJK 字体正确加载！

---

### 测试 4: CJK 排版优化

**目标**: 验证行高、字距等排版属性是否应用。

**操作**:
1. 确保界面语言为简体中文
2. 创建或打开一个包含大段中文的 Issue 或 User Story
3. 打开开发者工具检查文字元素的样式

**预期结果**:

```javascript
// 在控制台执行
const body = document.body;
const style = getComputedStyle(body);

console.log('Line Height:', style.lineHeight);
// 应该是 1.7 或更大

console.log('Letter Spacing:', style.letterSpacing);
// 应该有轻微的正值（如 0.48px）

console.log('Font Smoothing:', 
  style['-webkit-font-smoothing'],
  style['-moz-osx-font-smoothing']
);
// 应该是 "antialiased" 和 "grayscale"
```

**视觉检查**:
- ✅ 中文文字行间距舒适，不拥挤
- ✅ 文字清晰，边缘平滑
- ✅ 标点符号位置正确
- ✅ 中英文混排时间距适当

**如果成功** ✅ CJK 排版优化正常！

---

### 测试 5: HTML lang 属性自动更新

**目标**: 验证 `<html>` 标签的 `lang` 属性是否随语言切换而更新。

**操作**:
1. 在控制台执行：
```javascript
// 查看当前语言
document.documentElement.getAttribute('lang')
// 应该输出: "zh-hans"（如果是简体中文）

document.documentElement.getAttribute('dir')
// 应该输出: null （中文不是RTL语言）
```

2. 切换到阿拉伯语（Arabic）
3. 再次执行：
```javascript
document.documentElement.getAttribute('lang')
// 应该输出: "ar"

document.documentElement.getAttribute('dir')
// 应该输出: "rtl"（从右到左）
```

**预期结果**:
- ✅ `lang` 属性随语言切换自动更新
- ✅ RTL 语言自动设置 `dir="rtl"`
- ✅ LTR 语言自动移除 `dir` 属性

**如果成功** ✅ 语言属性自动更新正常！

---

### 测试 6: 引号样式（CJK 特有）

**目标**: 验证中文引号是否使用正确的样式。

**操作**:
1. 在任意页面创建包含引号的内容
2. 或在控制台创建测试元素：

```javascript
// 创建测试元素
const testDiv = document.createElement('div');
testDiv.innerHTML = '<q>这是一个引用</q>';
document.body.appendChild(testDiv);

// 检查引号样式
const quote = testDiv.querySelector('q');
const before = getComputedStyle(quote, '::before').content;
const after = getComputedStyle(quote, '::after').content;

console.log('开始引号:', before);  // 应该是 "\201C" (")
console.log('结束引号:', after);   // 应该是 "\201D" (")

// 清理
testDiv.remove();
```

**预期结果**:
- ✅ 简体中文使用 "" 引号
- ✅ 繁体中文使用 「」 引号
- ✅ 日语使用 「」 引号

**如果成功** ✅ 引号样式正确！

---

### 测试 7: 多语言切换稳定性

**目标**: 验证在多种语言之间频繁切换时系统的稳定性。

**操作**:
1. 登录 Taiga
2. 进入用户设置 → Profile
3. 快速切换以下语言（每种停留3-5秒）：
   - 英语 (English)
   - 简体中文 (Chinese Simplified)
   - 日语 (Japanese)
   - 韩语 (Korean)
   - 西班牙语 (Spanish)
   - 阿拉伯语 (Arabic)
   - 英语 (English) - 回到起点

4. 在切换过程中注意：
   - 界面是否立即响应
   - 是否有任何JavaScript错误
   - 日期格式是否正确更新
   - 文字渲染是否正常

**预期结果**:
- ✅ 所有语言切换顺畅，无延迟
- ✅ 控制台无错误信息
- ✅ 每种语言的字体和排版都正确
- ✅ RTL 语言（阿拉伯语）自动翻转布局
- ✅ 日期格式随语言变化

**如果成功** ✅ 多语言切换稳定！

---

### 测试 8: localStorage 缓存持久性

**目标**: 验证语言偏好在不同会话间的持久性。

**操作**:
1. 将语言切换到简体中文
2. 在控制台检查缓存：
```javascript
localStorage.getItem('taiga.locale')
// 应该输出: "zh-hans"
```

3. **完全关闭浏览器**（不只是标签页）
4. 重新打开浏览器，访问 Taiga
5. 再次检查：
```javascript
localStorage.getItem('taiga.locale')
// 仍然应该是: "zh-hans"

document.documentElement.getAttribute('lang')
// 仍然应该是: "zh-hans"
```

**预期结果**:
- ✅ 语言偏好在浏览器重启后仍然保留
- ✅ 页面自动应用之前选择的语言
- ✅ 无需重新登录或设置

**如果成功** ✅ 缓存持久性正常！

---

### 测试 9: 性能对比

**目标**: 对比优化前后的语言切换性能。

**操作**:
1. 打开开发者工具 → Network 标签
2. 清除缓存并硬刷新（Ctrl+Shift+R）
3. 记录首次加载时的网络请求
4. 再次刷新页面（Ctrl+R）
5. 对比两次的网络请求

**预期结果**:

**首次加载（无缓存）**:
- 会加载 locale JSON 文件
- 请求数量: 约 20-30 个

**第二次加载（有缓存）**:
- 不会重新加载 locale JSON（使用浏览器缓存）
- 语言偏好直接从 localStorage 读取
- 页面加载速度更快

**性能指标**:
```javascript
// 在控制台查看性能
performance.getEntriesByType('navigation')[0].domContentLoadedEventEnd
// 第二次应该比第一次更快
```

**如果成功** ✅ 性能优化生效！

---

### 测试 10: API 语言头正确性

**目标**: 验证 API 请求中的 `Accept-Language` 头是否正确设置。

**操作**:
1. 切换到简体中文
2. 打开开发者工具 → Network 标签
3. 执行任意触发 API 请求的操作（如刷新 Issues 列表）
4. 选择一个 API 请求（如 `/api/v1/issues`）
5. 查看 Request Headers

**预期结果**:
```
Accept-Language: zh-hans
```

**进一步验证**:
切换到其他语言后，该头应该随之更新：
- 英语: `Accept-Language: en`
- 日语: `Accept-Language: ja`
- 韩语: `Accept-Language: ko`

**如果成功** ✅ API 语言头正确！

---

## 高级测试

### 测试 11: 不同浏览器兼容性

**测试浏览器**:
- Chrome / Edge
- Firefox
- Safari (macOS)

**操作**:
在每个浏览器中重复测试 1-5

**预期结果**:
- ✅ 所有浏览器中功能一致
- ✅ 字体在各平台显示良好
- ✅ 无跨浏览器 bug

---

### 测试 12: 移动端适配

**操作**:
1. 在开发者工具中开启移动设备模拟（Toggle Device Toolbar）
2. 选择 iPhone 或 Android 设备
3. 重复关键测试（语言切换、日期格式、字体显示）

**预期结果**:
- ✅ 移动端字体大小适中
- ✅ 触摸操作顺畅
- ✅ 语言切换正常工作

---

## 验证清单

完成测试后，确认以下所有项：

- [ ] ✅ 语言偏好被 localStorage 缓存
- [ ] ✅ 页面刷新后语言自动恢复
- [ ] ✅ 中文日期使用 "2024年11月4日" 格式
- [ ] ✅ 相对时间显示中文（"3分钟前"）
- [ ] ✅ 星期显示为中文（"星期一"）
- [ ] ✅ 时段正确（凌晨、早上、下午、晚上）
- [ ] ✅ 中文字体为 PingFang SC / Microsoft YaHei
- [ ] ✅ 行高为 1.7，阅读舒适
- [ ] ✅ HTML lang 属性自动更新
- [ ] ✅ RTL 语言自动应用 dir="rtl"
- [ ] ✅ 中文引号使用 "" 样式
- [ ] ✅ 多语言切换无错误
- [ ] ✅ API 请求包含正确的 Accept-Language 头
- [ ] ✅ 跨浏览器兼容
- [ ] ✅ 移动端显示正常

---

## 故障排除

### 问题 1: 语言未被缓存

**现象**: 刷新页面后语言恢复为默认语言。

**解决方法**:
```bash
# 1. 检查 localStorage 是否启用
# 在控制台执行：
localStorage.getItem('test')
// 如果返回 null，说明 localStorage 正常

# 2. 检查 locale 服务是否初始化
grep -c "LocaleService" dist/v-*/js/app.js
# 应该 > 0

# 3. 重新编译
npx gulp app-deploy
```

### 问题 2: 中文日期格式不正确

**现象**: 日期仍然显示为 "Nov 4 2024" 而不是 "2024年11月4日"。

**解决方法**:
```javascript
// 在控制台检查 moment locale
moment.locale()
// 应该输出: "zh-cn"

// 如果不是，手动设置
moment.locale('zh-cn')

// 测试格式
moment().format('L')
// 应该输出中文格式
```

### 问题 3: CJK 样式未应用

**现象**: 中文文字没有使用优化的字体或行高。

**解决方法**:
```bash
# 1. 检查主题是否重新编译
ls -lh dist/v-*/styles/theme-taiga.css
# 文件应该最近被修改

# 2. 重新编译主题
npx gulp compile-themes

# 3. 清除浏览器缓存
# Ctrl+Shift+R 强制刷新
```

### 问题 4: 编译错误

**现象**: 运行 `npx gulp compile-themes` 时出错。

**解决方法**:
```bash
# 检查 SCSS 语法错误
npx gulp scss-lint

# 如果有错误，查看具体文件
# 通常是 custom.scss 中的 import 路径问题

# 修复后重新编译
npx gulp app-deploy
```

---

## 技术细节

### 新增文件

1. **app/coffee/modules/common/locale.service.coffee** (280 lines)
   - 语言管理服务
   - localStorage 缓存
   - Moment.js 集成
   - RTL 支持

2. **app/styles/extras/cjk-typography.scss** (约 300 lines)
   - CJK 字体栈
   - 排版优化
   - 引号样式
   - 响应式适配

### 修改文件

1. **app/coffee/app.coffee**
   - 添加 tgLocaleService 到 module.run
   - 初始化 locale 服务

2. **app/coffee/modules/auth.coffee**
   - 使用 locale 服务替代直接的 $translate 调用
   - 简化语言设置逻辑

3. **app/themes/taiga/custom.scss**
   - 导入 CJK typography 样式

### 配置项

在 `conf/conf.json` 中（已存在，无需修改）：
```json
{
  "defaultLanguage": "en",
  "rtlLanguages": ["ar", "fa", "he"]
}
```

---

## 测试完成后

如果所有测试都通过，国际化支持增强功能已成功实施！🎉

**下一步**:
- Plan A 第3项：Issues 页面移动端优化
- Plan A 第4项：单元测试添加

请告诉我测试结果，以便继续后续开发工作。
