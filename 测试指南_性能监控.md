# 前端性能监控功能测试指南

## 前置准备

### 1. 确认代码已编译

```bash
# 检查服务是否成功编译
cd /workspaces/taiga-front
grep -c "PerformanceMonitor\|MonitoringCollector" dist/v-*/js/app.js
# 应该输出大于 0 的数字（表示服务已编译到 app.js 中）
```

### 2. 启用监控功能

编辑配置文件 `conf/conf.json`（如果不存在则复制 `conf/conf.example.json`）：

```json
{
  "api": "http://localhost:8000/api/v1/",
  "monitoring": {
    "enabled": true,
    "reportInterval": 300000
  },
  "performanceMonitor": {
    "enabled": true
  }
}
```

**注意**: 
- `monitoring.enabled: true` - 启用监控系统
- `performanceMonitor.enabled: true` - 启用性能追踪
- `reportInterval: 300000` - 每 5 分钟生成一次报告（可选）

### 3. 启动开发服务器

```bash
npm start
```

等待编译完成后，浏览器会自动打开 `http://localhost:9001`

---

## 测试步骤

### 测试 1: 验证监控服务已初始化

**操作**:
1. 打开浏览器（推荐 Chrome/Firefox）
2. 访问 Taiga 首页 `http://localhost:9001`
3. 打开浏览器开发者工具（F12）
4. 切换到 Console 标签

**预期结果**:
```
[DEBUG] Performance Monitor: initialized
[DEBUG] Monitoring Collector: initialized
[DEBUG] Debug interface exposed at window.TaigaMonitoring
```

**如果看到以上信息** ✅ 监控服务初始化成功！

**如果没有看到**:
- 检查 `conf.json` 配置是否正确
- 刷新页面（Ctrl+F5 强制刷新）
- 检查是否有 JavaScript 错误

---

### 测试 2: 检查调试接口是否可用

**操作**:
在浏览器 Console 中输入：

```javascript
TaigaMonitoring
```

**预期结果**:
应该看到一个对象，包含以下方法：
```javascript
{
  getReport: ƒ ()
  getPerformanceMetrics: ƒ ()
  getErrors: ƒ ()
  clearMetrics: ƒ ()
}
```

**如果看到以上对象** ✅ 调试接口正常！

---

### 测试 3: 查看性能指标

**操作**:
在 Console 中执行：

```javascript
// 获取完整的性能报告
const report = TaigaMonitoring.getReport()
console.log(report)
```

**预期结果**:
应该看到一个包含以下内容的对象：

```javascript
{
  timestamp: 1730736000000,  // 当前时间戳
  performance: {
    recent: [...],            // 最近的性能指标
    apiTimings: [...],        // API 请求统计
    summary: {
      totalMetrics: 5,
      navigationCount: 1,
      errorCount: 0,
      avgPageLoadTime: 1234,
      apiEndpointsTracked: 2
    }
  },
  errors: [],                 // 错误历史
  environment: {...}          // 浏览器环境信息
}
```

**进一步检查**:

```javascript
// 只查看性能指标
TaigaMonitoring.getPerformanceMetrics()

// 查看 API 统计（以表格形式）
console.table(TaigaMonitoring.getPerformanceMetrics().apiTimings)
```

**如果能看到数据** ✅ 性能监控正在工作！

---

### 测试 4: 触发页面导航和 API 请求

**操作**:
1. 在 Taiga 中导航到不同页面（如：Projects、Issues、Kanban）
2. 等待 2-3 秒
3. 在 Console 中再次查看指标：

```javascript
const metrics = TaigaMonitoring.getPerformanceMetrics()

// 查看导航指标
console.log('导航次数:', metrics.summary.navigationCount)
console.log('平均页面加载时间:', metrics.summary.avgPageLoadTime, 'ms')

// 查看 API 请求统计
console.log('追踪的 API 端点数:', metrics.summary.apiEndpointsTracked)
console.table(metrics.apiTimings)
```

**预期结果**:
- `navigationCount` 应该增加
- `apiTimings` 数组应该有数据，显示各个 API 的请求统计：
  ```
  ┌─────────┬─────────────────────┬───────┬─────────────┬─────────────┬─────────────┬───────────┐
  │ (index) │      endpoint       │ count │ avgDuration │ minDuration │ maxDuration │ errorRate │
  ├─────────┼─────────────────────┼───────┼─────────────┼─────────────┼─────────────┼───────────┤
  │    0    │ 'GET /api/v1/...'   │   5   │     234     │     123     │     456     │     0     │
  │    1    │ 'POST /api/v1/...'  │   2   │     567     │     456     │     678     │     0     │
  └─────────┴─────────────────────┴───────┴─────────────┴─────────────┴─────────────┴───────────┘
  ```

**如果看到数据更新** ✅ API 监控正常工作！

---

### 测试 5: 验证慢请求警告

**操作**:
1. 打开 Console 并保持开启
2. 如果你的后端 API 响应较慢，或者故意在网络面板中限速（Chrome DevTools → Network → Throttling → Slow 3G）
3. 导航到数据较多的页面（如 Issues 列表）

**预期结果**:
如果有请求超过 3 秒，应该看到警告：
```
[WARN] Slow API request: {url: "/api/v1/issues", duration: 3456, status: 200}
```

如果页面加载超过 5 秒，应该看到：
```
[WARN] Slow page load: {route: "/issues", totalTime: 5234}
```

**如果看到警告** ✅ 阈值检测正常！

---

### 测试 6: 错误追踪功能

**操作 A: 触发 404 错误**
1. 在浏览器中访问一个不存在的页面，例如：`http://localhost:9001/project/nonexistent-project/issues`
2. 在 Console 中查看错误历史：

```javascript
TaigaMonitoring.getErrors()
```

**预期结果**:
应该看到错误记录：
```javascript
[
  {
    type: "not_found",
    timestamp: 1730736000000,
    url: "http://localhost:9001/project/nonexistent-project/issues",
    path: "/project/nonexistent-project/issues",
    userAgent: "Mozilla/5.0...",
    context: {...}
  }
]
```

**操作 B: 触发 JavaScript 错误**
在 Console 中故意执行错误代码：
```javascript
// 这会触发一个错误
throw new Error("测试错误追踪")
```

然后查看错误：
```javascript
const errors = TaigaMonitoring.getErrors()
console.log('错误数量:', errors.length)
console.log('最新错误:', errors[errors.length - 1])
```

**如果能看到错误记录** ✅ 错误追踪正常！

---

### 测试 7: 内存监控

**操作**:
1. 保持页面打开 30 秒以上
2. 查看性能指标：

```javascript
const metrics = TaigaMonitoring.getPerformanceMetrics()

// 查找内存指标
const memoryMetrics = metrics.recent.filter(m => m.type === 'memory')
console.log('内存监控记录数:', memoryMetrics.length)
console.log('最新内存使用:', memoryMetrics[memoryMetrics.length - 1])
```

**预期结果**:
应该看到内存使用情况（仅 Chrome 支持）：
```javascript
{
  type: "memory",
  timestamp: 1730736030000,
  usedHeap: 45,      // MB
  totalHeap: 60,     // MB
  heapLimit: 2048    // MB
}
```

**如果看到内存数据** ✅ 内存监控正常！

**注意**: Safari/Firefox 可能不支持 `performance.memory`，这是正常的。

---

### 测试 8: 数据清除功能

**操作**:
```javascript
// 清除所有监控数据
TaigaMonitoring.clearMetrics()

// 验证数据已清除
const report = TaigaMonitoring.getReport()
console.log('总指标数:', report.performance.summary.totalMetrics)  // 应该是 0
console.log('错误数:', report.errors.length)  // 应该是 0
```

**预期结果**:
所有指标和错误历史应该被清空。

**如果数据被清空** ✅ 清除功能正常！

---

### 测试 9: 慢资源检测

**操作**:
1. 打开一个包含图片或大文件的页面
2. 在 Network 面板中限速（Throttling → Slow 3G）
3. 刷新页面
4. 等待页面加载完成（约 5-10 秒）
5. 查看慢资源：

```javascript
const metrics = TaigaMonitoring.getPerformanceMetrics()
const slowResources = metrics.recent.filter(m => m.type === 'slow_resources')
console.log('慢资源记录:', slowResources)
```

**预期结果**:
如果有资源加载超过 500ms，应该看到：
```javascript
[
  {
    type: "slow_resources",
    timestamp: 1730736000000,
    count: 3,
    resources: [
      {name: "image.png", duration: 1234, size: 123456},
      {name: "app.js", duration: 876, size: 654321},
      // ...
    ]
  }
]
```

**如果看到慢资源** ✅ 资源监控正常！

---

## 高级测试

### 测试 10: 定期上报功能（可选）

如果你想测试自动上报功能：

**1. 配置上报端点**:
```json
{
  "monitoring": {
    "enabled": true,
    "reportInterval": 10000,  // 10 秒（测试用）
    "reportEndpoint": "http://localhost:8080/api/metrics"  // 你的测试端点
  }
}
```

**2. 设置一个简单的接收服务器**:
```bash
# 使用 netcat 监听端口
nc -l 8080
```

**3. 等待 10 秒**，应该看到 POST 请求数据。

**注意**: 这个功能是可选的，默认不需要配置端点。

---

## 验证清单

完成以下所有测试后，确认功能正常：

- [ ] ✅ 监控服务初始化成功（看到 DEBUG 日志）
- [ ] ✅ `TaigaMonitoring` 调试接口可用
- [ ] ✅ 能获取性能报告数据
- [ ] ✅ 页面导航被追踪（navigationCount 增加）
- [ ] ✅ API 请求被记录（apiTimings 有数据）
- [ ] ✅ 慢请求触发警告（>3s 的 API 或 >5s 的页面加载）
- [ ] ✅ 404 错误被记录
- [ ] ✅ JavaScript 错误被追踪
- [ ] ✅ 内存使用被监控（每 30 秒，仅 Chrome）
- [ ] ✅ 数据可以清除
- [ ] ✅ 慢资源被检测（>500ms）

---

## 故障排除

### 问题 1: 页面白屏，控制台报 "Circular dependency" 错误

**已修复**: 这个问题已经在代码中解决了。

**原因**: 
- Angular 的依赖注入系统检测到循环依赖
- `$rootScope` → `$exceptionHandler` → `tgPerformanceMonitor` → `$rootScope`

**解决方案**: 
- 使用延迟注入（`$injector`）打破循环
- 在初始化时动态获取 `$rootScope`

如果仍然遇到此问题，请确保代码已重新编译：
```bash
npx gulp app-deploy
```

### 问题 2: 看不到初始化日志

**可能原因**:
- 配置未启用
- 浏览器缓存未清除

**解决方法**:
```bash
# 1. 检查配置
cat conf/conf.json | grep -A 5 "monitoring"

# 2. 清除浏览器缓存并强制刷新（Ctrl+Shift+R）

# 3. 重新编译
npm start
```

### 问题 2: 看不到初始化日志

**可能原因**:
- 配置未启用
- 浏览器缓存未清除

**解决方法**:
```bash
# 1. 检查配置
cat conf/conf.json | grep -A 5 "monitoring"

# 2. 清除浏览器缓存并强制刷新（Ctrl+Shift+R）

# 3. 重新编译
npm start
```

### 问题 3: TaigaMonitoring 未定义

**可能原因**:
- 监控未启用
- 代码未编译

**解决方法**:
```bash
# 确认服务已编译
grep -c "MonitoringCollector" dist/v-*/js/app.js

# 如果输出 0，重新编译
npx gulp app-deploy
```

### 问题 3: TaigaMonitoring 未定义

**可能原因**:
- 监控未启用
- 代码未编译

**解决方法**:
```bash
# 确认服务已编译
grep -c "MonitoringCollector" dist/v-*/js/app.js

# 如果输出 0，重新编译
npx gulp app-deploy
```

### 问题 4: 没有性能数据

**可能原因**:
- 页面刚打开，还没有导航
- performanceMonitor 未启用

**解决方法**:
1. 多导航几个页面
2. 检查 `conf.json` 中 `performanceMonitor.enabled: true`

### 问题 4: 没有性能数据

**可能原因**:
- 页面刚打开，还没有导航
- performanceMonitor 未启用

**解决方法**:
1. 多导航几个页面
2. 检查 `conf.json` 中 `performanceMonitor.enabled: true`

### 问题 5: 浏览器不支持

**解决方法**:
使用以下浏览器之一：
- Chrome 60+
- Firefox 55+
- Safari 11+
- Edge 79+

---

## 测试完成后

如果所有测试都通过，请告诉我测试结果，我会继续实施后续功能：

2. 国际化支持增强
3. Issues 页面移动端优化
4. 单元测试添加

**测试愉快！** 🎉
